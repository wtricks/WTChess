/**
 * WTChess - A small & fast javascript chess engine
 * 
 * @author Anuj Kumar <webtricks.ak@gmail.com>
 * @link https://github.com/wtricks/wtchess
 * @link https://instagram.com/webtricks.ak
 */
const WTChess=function(){let d=["A","B","C","D","E","F","G","H"],e=[8,7,6,5,4,3,2,1],f=["Kk","BKk","KNk","KNNk","Kbk","Kkn","Kknn"],g={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7},b={QUEEN_CASTLE:"Q",KING_CASTLE:"K",PROMOTION:"P",BIG_PAWN:"B",E_PASSANT:"E"},a={WHITE:"W",BLACK:"B"},h={},c={KING:"K",QUEEN:"Q",PAWN:"P",KNIGHT:"N",ROOK:"R",BISHOP:"B"},i=["promote","capture","move","add","remove","load","swap","check","gameover","fiftymove"],j={W:3,B:6},k={W:8,B:1},l={R:[[-1,0],[1,0],[0,-1],[0,1]],B:[[-1,1],[1,1],[1,-1],[-1,-1]],N:[[-1,2],[1,2],[-1,-2],[1,-2],[-2,1],[-2,-1],[2,1],[2,-1]],K:[[-1,0],[1,0],[0,-1],[0,1],[-1,1],[1,1],[1,-1],[-1,-1]],Q:[[-1,0],[1,0],[0,-1],[0,1],[-1,1],[1,1],[1,-1],[-1,-1]],P:{W:[[0,1],[-1,1],[1,1]],B:[[0,-1],[-1,-1],[1,-1]]}},m={K:1,N:1,B:7,R:7,Q:7,P:1},n={},o=a.WHITE,p={},q=0,r="",s="-",t=null,u="",v=[],w=[],x={},y={},z=[],A={W:{},B:{}},B={W:0,W:0},C=!1;function D(f,a){let e={valid:[],capture:[]};return(a==c.PAWN?l.P[o]:l[a]).forEach((r,n)=>{let p=f,t=null;for(let u=0;u<m[a];u++){let q=g[p[0]]+r[0],i=+p[1]+r[1];if(q>=0&&i>0&&q<8&&i<9){let h=d[q]+i,l=x[h];if(l?.COLOR===o)break;if(c.PAWN===a){k[o]==i&&(e.flag=b.PROMOTION),(l||0!==n)&&(0===n||s!==h)?l&&0!==n&&l.COLOR!==o&&e.capture.push(h):e.valid.push(h),x[t=d[q]+(3===j[o]?4:5)]||c.PAWN!==a||j[o]!=i||0!==n||e.valid.push(t),p=h;break}if(l&&x.COLOR!==o){e.capture.push(h);break}e.valid.push(h),p=h}else break}}),e}function E(b){z=[];let a=y[o];return y[o]=null,[c.QUEEN,c.PAWN,c.KNIGHT].forEach(a=>{D(b,a).capture.forEach(d=>{if(a==c.QUEEN){var e,f;let h=(e=d,f=b,e[0]==f[0]||e[1]==f[1]?"P":Math.abs(e[1]-f[1])==Math.abs(g[e[0]]-g[f[0]])?"D":void 0),i=Math.abs(d[1]-b[1])??Math.abs(g[d[0]]-g[b[0]]);1==i&&"P"===h&&[c.QUEEN,c.ROOK,c.KING].some(a=>a==x[d].PIECE)?z.push(d):1==i&&"D"===h&&[c.QUEEN,c.BISHOP,c.KING].some(a=>a==x[d].PIECE)?z.push(d):"P"===h&&[c.QUEEN,c.ROOK].some(a=>a==x[d].PIECE)?z.push(d):"D"===h&&[c.QUEEN,c.BISHOP].some(a=>a==x[d].PIECE)&&z.push(d)}else x[d]?.PIECE==a&&z.push(d)})}),y[o]=a,z}function F(a=!1){a?p=[o,Object.assign({},x),Object.assign({},y),Object.assign({},A),z,Object.assign({},B),q,r]:(o=p[0],x=p[0],y=p[2],A=p[3],z=p[4],B=p[5],q=p[6],r=p[7],p.length=0)}function G(){let e=[],f=8,b=0,d="";for(let c in x)c[1]!=f&&(e.push(d+(b||"")),f=c[1],d="",b=0),x[c]?(b&&(d+=b)&&(b=0),d+=x[c].COLOR==a.BLACK?x[c].PIECE.toLowerCase():x[c].PIECE):b+=1;return e.push(d+(b||"")),e.join("/")}function H(e,a){if(A[o][e]&&y[o]=="E"+a&&0==z.length){let d=e==c.QUEEN?["B"+a,"C"+a,"D"+a]:["F"+a,"G"+a],f=d.length;for(let b=0;b<f;b++)if(x[d[b]]||E(d[b]).length>0)return!1;return!0}}function I(f){let d={valid:[],capture:[]},e=o==a.WHITE,g=z;for(let h in f)f[h].forEach(a=>{0==E(a).length&&d[h].push(a)});return z=g,d.valid.length>0&&H(c.QUEEN,e?1:8)&&(d.valid.push(e?"D1":"D8"),d.flag=b.QUEEN_CASTLE),d.valid.length>0&&H(c.KING,e?1:8)&&(d.valid.push(e?"G1":"G8"),d.flag=b.KING_CASTLE),d}function J(b){let e=x.hasOwnProperty(b)?x[b]:null;if(!e||e.COLOR!==o||r)return{valid:[],capture:[]};let f=D(b,e.PIECE);if(e.PIECE==c.KING)return I(f);if(z.length>0)return function(b){if(z.length>1)return{valid:[],capture:[]};if(x[z[0]]?.PIECE==c.KNIGHT)return b.capture.some(a=>a==z[0])?{valid:[],capture:[z[0]]}:{valid:[],capture:[]};if(x[z[0]]?.PIECE==c.PAWN)return y[o][1]==z[0][1]+(o==a.WHITE?-1:1)?b.capture.some(a=>a==z[0])?{valid:[],capture:[z[0]]}:{valid:[],capture:[]}:b;let h=function(k,e){let f=[[0,1],[0,-1],[-1,0],[1,0],[-1,1],[1,1],[-1,-1],[1,-1]];for(let b=0;b<8;b++){let h=[],a=k;for(let i=0;i<m[x[e].PIECE];i++){let j=g[a[0]]+f[b][0],c=+a[1]+f[b][1];if(j&&0!=c&&!(c>8)){if(a=d[j]+c,h.push(a),a==e)return h;if(x[a])break}}}}(y[o],z[0]),e={valid:[],capture:[]};for(let f in b)b[f].forEach(a=>{h.includes(a)&&e[f].push(a)});return e}(f);let h=x[b];return(x[b]=null,E(y[o]).length>0)?{valid:[],capture:[]}:(x[b]=h,f)}function K(){let b=I(D(y[o],c.KING));if(0==(b=b.valid.concat(b.capture)).length){for(let g in x)if(x[g]?.COLOR==o&&x[g]?.PIECE!==c.KING&&(b=(b=D(g,x[g].PIECE)).valid.concat(b.capture)).length>0)break}if(h.checkmate&&z.length>0&&0==b.length)return"CHECKMATE";if(h.fiftymove&&B[a.WHITE]>49&&m[a.BLACK]>49)return"50MOVE";if(h.stalemate&&0==z.length&&0==b.length)return"STALEMATE";if(h.threeFoldRepetition){let k={};if(w.forEach(a=>k[a]=a in k?k[a]+1:1),Object.values(k).some(a=>a>=3))return"T-FOLD"}if(h.insufficiantMaterial){let i={},e="";for(let d in x)if(x[d]){let j=x[d].COLOR==a.BLACK?x[d].PIECE.toLowerCase():x[d].PIECE;x[d]?.PIECE==c.BISHOP&&(i[j]=d),e+=j}if(e=e.split("").sort().join(""),f.includes(e)||"BKbk"==e&&[1,3,5,7].includes(i.b[1])!==[1,3,5,7].includes(i.B[1]))return"I-MATERIAL"}}function L(){return o==a.WHITE?a.BLACK:a.WHITE}return{square:function(b){return s===b?{PIECE:c.PAWN,COLOR:o===a.WHITE?a.BLACK:a.WHITE,ePassant:!0}:x[b.toUpperCase()]??null},position:function(){return x},move:function(d,e){let g="";if("object"==typeof d&&(e=d.to,d=d.from,g=d.flag??""),Array.isArray(u)){if(!u.some(a=>a.to==e&&a.from==d))return}else if(u.from!==d||!u.valid.concat(u.capture).some(a=>a===e))return;if(r||!x[d])return;g=Array.isArray(u)?"":u?.flag??"";let f={from:d,to:e,castles:A,count:B,ePassant:s,castle:null};if("-"!==s&&(x[d].PIECE!==c.PAWN||o==a.WHITE&&5!=d[1]||o==a.BLACK&&4!=d[1])&&(s="-"),x[e])w.length=0,B[o]=0,f.capture={piece:x[e].PIECE,square:e},n.capture(e,x[e].PIECE,L()),n.remove(e,"CAPTURE");else if(x[d]?.PIECE==c.PAWN&&e==s){let h=s[0]+(o==a.WHITE?5:4);n.capture(h,c.PAWN,L(),"epssant"),n.remove(h,"EPASSANT"),x[h]=null,f.capture={square:h,piece:c.PAWN},w.length=0,B[o]=0}else x[d].PIECE==c.PAWN?B[o]=0:B[o]++,x[d].PIECE==c.PAWN?2==d[1]&&4==e[1]&&(s=d[0]+3)||7==d[1]&&5==e[1]&&(s=d[0]+6):"-"!=s&&(s="-");if(x[d].PIECE==c.KING?(y[o]=e,A[o]={}):x[d].PIECE==c.ROOK&&A[o]["A"==d[0]?"Q":"K"]&&(A[o]["A"==d[0]?"Q":"K"]=!1),x[e]=x[d],x[d]=null,n.move(d,e,x[e].PIECE),g.includes(b.PROMOTION)){let i=n.promote(e)??c.QUEEN;i=[c.QUEEN,c.ROOK,c.BISHOP,c.KNIGHT].some(a=>a==i)?i:c.QUEEN,x[e].PIECE=i,f.promote=i,w.length=0,n.remove(e,"PROMOTE"),n.add(e,x[e].COLOR,x[e].PIECE)}else g.includes(b.QUEEN_CASTLE)?(x["C"+(o==a.WHITE?1:8)]=x["A"+(o==a.WHITE?1:8)],x["A"+(o==a.WHITE?1:8)]=null,f.castle={from:"A"+(o==a.WHITE?1:8),to:"C"+(o==a.WHITE?1:8)},n.move(f.castle.from,f.castle.to,c.ROOK)):g.includes(b.KING_CASTLE)&&(x["F"+(o==a.WHITE?1:8)]=x["H"+(o==a.WHITE?1:8)],x["H"+(o==a.WHITE?1:8)]=null,f.castle={from:"H"+(o==a.WHITE?1:8),to:"F"+(o==a.WHITE?1:8)},n.move(f.castle.from,f.castle.to,c.ROOK));if(B[o]>49&&n.fiftymove(o),C||(w.push(G()),v.length>q&&v.splice(q),v.push(f),q=v.length),n.swap(o=L()),E(y[o]).length>0&&n.check(z.map(a=>({piece:x[a].PIECE,square:a,color:x[a].COLOR}))),r=K())return n.gameover(r,L())},moves:function(d=!1){if(!r)return u=d?J(d):function(){let g=[];for(let d in x)if(x[d]&&x[d].COLOR==o){let f=J(d);for(let e in f)("valid"==e||"capture"==e)&&f[e].forEach((h,l)=>{let j="capture"==e?x[h]?x[h].PIECE:x[h[0]+(o==a.WHITE?4:5)].PIECE:void 0,k=f.flag?f.flag:"",i;k+=("valid"==e&&x[d]?.PIECE==c.PAWN&&1==l?b.BIG_PAWN:"")+(j?b[x[h]?"CAPTURE":"E_PASSANT"]:""),i={from:d,to:h,piece:x[d].PIECE,color:o},j&&(i.capture=j),k&&(i.flag=k),g.push(i)})}return t=g}(),Array.isArray(u)||(u.from=d),u},undo:function(){let a=(v[q-1],v[q-1]);if(!a||r)return"No more undo";q--,A=a.castles,B=a.count,s=a.ePassant,a.castle?(x[a.castle.from]=x[a.castle.to],x[a.castle.to]=null,n.move(a.castle.to,data.castle.from,c.ROOK)):a.promote&&(x[a.to].PIECE=c.PAWN,n.remove(a.to,"UNDO"),n.add(a.to,x[a.to].COLOR,x[a.to].PIECE)),n.move(a.to,a.from,x[a.to].PIECE),x[a.from]=x[a.to],x[a.to]=null,a.capture&&(x[a.capture.square]={PIECE:a.capture.piece,COLOR:o},n.add(a.capture.square,x[a.capture.square].COLOR,x[a.capture.square].PIECE)),w.pop(),B[o]-=1,r="",n.swap(o=L()),x[a.from].PIECE==c.KING&&(y[o]=a.from),E(y[o]).length>0&&n.check(z.map(a=>({piece:x[a].PIECE,square:a,color:x[a].COLOR})))},redo:function(){let a=(v[q],v[q]);if(!a||r)return"No more redo";q++,C=!0,this.moves(a.from),this.move(a.from,a.to),C=!1},fen:function(){let d=G(),e=o.toLowerCase(),b="";return A[a.WHITE][c.KING]&&(b+=c.KING),A[a.WHITE][c.QUEEN]&&(b+=c.QUEEN),A[a.BLACK][c.KING]&&(b+=c.KING.toLowerCase()),A[a.BLACK][c.QUEEN]&&(b+=c.QUEEN.toLowerCase()),`${d} ${e} ${b||"-"} ${s.toLowerCase()} ${B[a.BLACK]} ${B[a.WHITE]}`},load:function(b="",g){if(g=g??{},6!==(b=(b=b||"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 0").split(/\s+/g)).length)return"Invalid FEN string found";F(!0),y={},e.forEach(a=>d.forEach(b=>x[b+a]=null));try{if(b[0]=b[0].split("/"),8!==b[0].length)throw new Error("Invalid FEN string found");let l=0;if(b[0].forEach((f,b)=>{if(0!==l&&8!==l)throw new Error(`In the ${b}${0==b?"st":1==b?"nd":0==b?"rd":"th"} row must have 8 square`);l=0,f.split("").forEach(f=>{if("12345678".includes(f)){l+=parseInt(f);return}if(++l>8)throw new Error(`Maximum 8 piece is allowed in ${b+1}${0==b?"st":1==b?"nd":0==b?"rd":"th"} row`);let g=Object.values(c).join("").includes(f)?a.WHITE:Object.values(c).map(a=>a.toLowerCase()).join("").includes(f)?a.BLACK:null;if(null==g)throw new Error(`Invalid piece code given in '${f}' in ${b+1}${0==b?"st":1==b?"nd":0==b?"rd":"th"} row`);if(f=f.toUpperCase(),x[d[l-1]+e[b]]={PIECE:f,COLOR:g},f==c.KING&&y[g])throw new Error("One side must have only one king");f==c.KING&&(y[g]=d[l-1]+e[b])})}),!y[a.WHITE]&&!y[a.BLACK])throw new Error("Both side have no king");if(!y[a.WHITE])throw new Error("White has not king");if(!y[a.BLACK])throw new Error("Black has not king")}catch(k){return F(),k.message}for(let j in i.forEach(a=>!n.hasOwnProperty(a)&&(n[a]=function(){})),["fiftymove","insufficiantMaterial","threeFoldRepetition","stalemate","checkmate"].forEach(a=>h[a]=!g[a]||g[a]),B[a.BLACK]=parseInt(b[4]),B[a.WHITE]=parseInt(b[5]),B={W:0,B:0},[a.BLACK,a.WHITE].forEach(a=>{E(y[o=a]).length>0&&n.check(z.map(a=>({piece:x[a].PIECE,square:a,color:x[a].COLOR}))),(r=K())&&n.gameover(r,L())}),r||(r=""),o=b[1]==a.BLACK.toLowerCase()?a.BLACK:a.WHITE,s=b[3].toUpperCase(),q=0,A[a.WHITE].K=b[2].includes(c.KING),A[a.BLACK].K=b[2].includes(c.KING.toLowerCase()),A[a.WHITE].Q=b[2].includes(c.QUEEN),A[a.BLACK].Q=b[2].includes(c.QUEEN.toLowerCase()),n.load(),n.swap(o),p[1])x[j]&&n.remove(j,"NEW");for(let f in p.length=0,x)x[f]&&n.add(f,x[f].COLOR,x[f].PIECE)},print:function(f=!0){let g={W:{K:"\u2654",P:"\u2659",N:"\u2658",R:"\u2656",B:"\u2657",Q:"\u2655"},B:{K:"\u265A",P:"\u265F",N:"\u265E",R:"\u265C",B:"\u265D",Q:"\u265B"}},c="",d=8,e=b=>x[b]?f?g[x[b].COLOR][x[b].PIECE]:x[b].COLOR==a.BLACK?x[b].PIECE.toLowerCase():x[b].PIECE.toUpperCase():"-";for(let b in x)c+=`${"A"===b[0]?`${d} |`:""} ${e(b)}${"H"===b[0]?`\n`:" "}`,"H"===b[0]&&d--;return c+="- - -  -  -  -  -  -  -  -\n",c+="  | a  b  c  d  e  f  g  h"},turn:function(){return o},status:function(){return r},on:function(a,b){return i.some(b=>b==a)?"function"!=typeof b?`Invalid event handler given with '${a}' name`:void(n[a]=b):`Unknown event name '${a}' given`},FLAGS:b,COLOR:a,PIECE:c}}
